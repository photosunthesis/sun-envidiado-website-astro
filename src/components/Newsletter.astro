---
const { hasBorderTop = false } = Astro.props;
---

<section class:list={['newsletter-section', { 'has-border-top': hasBorderTop }]}>
  <div class="newsletter-container">
    <p class="newsletter-desc">
      Subscribe for new post notifications. Zero spam, I promise! Or try <a href="/rss.xml">RSS</a>.
    </p>

    <form class="newsletter-form" id="newsletter-form">
      <div class="input-group">
        <label for="email" class="sr-only">Email address</label>
        <input
          type="email"
          id="email"
          name="email"
          placeholder="your@email.com"
          required
          class="newsletter-input"
        />
        <button type="submit" class="newsletter-btn">Subscribe â†ª</button>
      </div>
      <div class="form-message" id="form-message" aria-live="polite"></div>
    </form>
  </div>
</section>

<script>
  const form = document.getElementById('newsletter-form') as HTMLFormElement;
  const messageEl = document.getElementById('form-message');
  const btn = form?.querySelector('button');

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!btn || !messageEl) return;

      const formData = new FormData(form);
      const email = formData.get('email');
      const originalBtnText = btn.textContent;

      btn.disabled = true;
      btn.textContent = 'Sending...';
      messageEl.textContent = '';
      messageEl.className = 'form-message';

      try {
        const res = await fetch('/api/subscribe-to-blog', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email }),
        });

        await res.json();

        if (!res.ok) throw new Error();

        messageEl.textContent = 'Check your email to confirm your subscription.';
        messageEl.classList.add('success');
        form.reset();
      } catch {
        messageEl.textContent = 'Something went wrong. Please try again later.';
        messageEl.classList.add('error');
      } finally {
        btn.disabled = false;
        btn.textContent = originalBtnText;
      }
    });
  }
</script>

<style lang="scss">
  .newsletter-section {
    transition: opacity 0.2s ease;

    &:hover {
      opacity: 1;
    }

    &.has-border-top {
      border-top: 1px dashed var(--comment);
      padding-top: 2rem;
      margin-top: 3rem;
    }
  }

  .newsletter-container {
    width: 100%;
  }

  .newsletter-desc {
    margin-bottom: 1.5rem;
    line-height: 1.5;

    a {
      font-size: inherit;
      text-decoration: underline;
      text-underline-offset: 2px;

      &:hover {
        color: var(--cyan);
      }
    }
  }

  .input-group {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
  }

  .newsletter-input {
    flex: 1;
    min-width: 200px;
    padding: 0.5rem 0.75rem;
    background: transparent;
    border: 1px solid var(--foreground);
    color: var(--foreground);
    font-family: inherit;
    font-size: 0.9rem;
    border-radius: 4px;

    &:focus {
      outline: none;
      border-color: var(--foreground);
    }

    &::placeholder {
      color: var(--foreground);
      opacity: 0.5;
    }
  }

  .newsletter-btn {
    padding: 0.4rem 1rem;
    background: var(--foreground);
    color: var(--background);
    font-family: inherit;
    font-size: 0.9rem;
    font-weight: normal;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s ease;

    &:hover:not(:disabled) {
      opacity: 0.9;
    }

    &:disabled {
      opacity: 0.5;
      cursor: wait;
    }

    @media (max-width: 480px) {
      padding: 0.5rem 1rem;
    }
  }

  .form-message {
    margin-top: 1rem;
    font-size: 0.9rem;

    &.success {
      color: var(--green);
    }

    &.error {
      color: var(--red);
    }
  }
</style>
