---
import BaseLayout from "../layouts/BaseLayout.astro";

// Import all Markdown blog posts in this folder (eager so frontmatter is available)
const modules = import.meta.glob("./blog/*.md", { eager: true });

// Build an array of posts with frontmatter and url
type Post = { title: string; pubDate: Date; url: string; index?: number };
const postList = Object.entries(modules)
  .map(([path, mod]) => {
    const parts = path.split("/");
    const last = parts.pop() || "";
    const slug = last.replace(/\.md$/, "");
    const fm = (mod as any).frontmatter || {};
    const pubDate = fm.pubDate ? new Date(fm.pubDate) : null;
    return {
      title: fm.title || slug,
      pubDate,
      url: `/blog/${slug}`,
    } as Post;
  })
  .filter((p) => p.pubDate) as Post[];

// Sort by date desc
postList.sort((a, b) => b.pubDate.valueOf() - a.pubDate.valueOf());

// Add stable numeric index (1-based) for command selection and index listing
postList.forEach((p, i) => (p.index = i));

// Group by year
const grouped: Record<number, Post[]> = {};
for (const post of postList) {
  const year = post.pubDate.getFullYear();
  if (!grouped[year]) grouped[year] = [];
  grouped[year].push(post);
}

const homeUrlLabel = ":home<Enter>";
const blogIndexLabel = ":blog[index]";
---

<BaseLayout title="Blog" description="List of all blog posts.">
  <div class="blog-content">
    <p class="blog-content-start">
      Select a blog post by tapping its title or typing <a href="/"
        >{blogIndexLabel}</a
      >. To return to the homepage, tap or type <a href="/">{homeUrlLabel}</a>.
    </p>
    <div class="posts-wrapper">
      {
        Object.keys(grouped)
          .sort((a, b) => Number(b) - Number(a))
          .map((year) => (
            <section class="year-group">
              <h2 class="year-heading">{year}</h2>
              <ul class="year-list">
                {grouped[Number(year)].map((post) => (
                  <li
                    class="post-row"
                    data-blog-index={post.index}
                    data-blog-url={post.url}
                  >
                    <span class="post-index">{post.index}</span>
                    <a class="post-link" href={post.url}>
                      {post.title}
                    </a>
                    <time class="post-date">
                      {post.pubDate.toLocaleDateString("en-US", {
                        month: "short",
                        day: "numeric",
                        year: "numeric",
                      })}
                    </time>
                  </li>
                ))}
              </ul>
            </section>
          ))
      }
    </div>
  </div>
</BaseLayout>
