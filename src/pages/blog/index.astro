---
import BackButton from '../../components/BackButton.astro';
import Newsletter from '../../components/Newsletter.astro';
import BaseLayout from '../../layouts/BaseLayout.astro';

import { getCollection } from 'astro:content';

const posts = (await getCollection('blog')).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

// Group posts by year using reduce for clarity
const grouped = posts.reduce(
  (acc, p, i) => {
    const year = p.data.pubDate.getFullYear();
    (acc[year] ||= []).push({
      title: p.data.title,
      pubDate: p.data.pubDate,
      url: `/blog/${p.slug}`,
      index: i,
    });
    return acc;
  },
  {} as Record<number, { title: string; pubDate: Date; url: string; index: number }[]>,
);

// Keep older variable names compatible with templates below
// Used for JSON-LD construction
const postList = posts.map((p, i) => ({
  title: p.data.title,
  pubDate: p.data.pubDate,
  url: `/blog/${p.slug}`,
  index: i,
}));

// SEO-optimized metadata
const seoMeta = {
  title: 'Blog â€” Sun Envidiado',
  description:
    'Random thoughts from Sun about coding, gaming, life updates, and whatever else crosses my mind. No formal structure, just honest musings about tech and everything in between.',
  tags: [
    'sun envidiado blog',
    'developer blog',
    'coding thoughts',
    'gaming blog',
    'personal blog',
    'tech musings',
  ],
};

// SEO / Structured Data
const siteBase = Astro.site || 'https://sun-envidiado.com';

// Optimized JSON-LD for a blog with individual posts
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Blog',
  '@id': `${siteBase}/blog#blog`,
  name: seoMeta.title,
  description: seoMeta.description,
  url: `${siteBase}/blog`,
  author: {
    '@type': 'Person',
    '@id': `${siteBase}/#person`,
    name: 'Sun Envidiado',
  },
  blogPost: postList.map((p) => ({
    '@type': 'BlogPosting',
    headline: p.title,
    url: new URL(p.url, siteBase).toString(),
    datePublished: p.pubDate.toISOString(),
    author: {
      '@type': 'Person',
      name: 'Sun Envidiado',
    },
  })),
};
---

<BaseLayout
  title={seoMeta.title}
  description={seoMeta.description}
  tags={seoMeta.tags}
  type="website"
  jsonLd={jsonLd}
>
  <div class="blog-content">
    <header class="blog-header">
      <h1 id="blog-title" class="sr-only">Blog</h1>
      <BackButton />
    </header>

    <Newsletter />

    <div class="posts-wrapper">
      {
        Object.keys(grouped)
          .sort((a, b) => Number(b) - Number(a))
          .map((year) => (
            <section class="year-group">
              <h2 class="year-heading" id={`year-${year}`}>
                {year}
              </h2>
              <ul class="year-list" aria-labelledby={`year-${year}`}>
                {grouped[Number(year)].map((post) => (
                  <li class="post-row" data-blog-index={post.index} data-blog-url={post.url}>
                    <a class="post-link" href={post.url} rel="bookmark">
                      {post.title}
                    </a>
                    <time class="post-date hide-on-mobile" datetime={post.pubDate.toISOString()}>
                      {post.pubDate.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric',
                      })}
                    </time>
                  </li>
                ))}
              </ul>
            </section>
          ))
      }
    </div>
  </div>
</BaseLayout>

<style lang="scss">
  .blog-content {
    max-width: 500px;
    text-align: left;
    width: 100%;

    @media (max-width: 480px) {
      padding: 1.5rem 1.5rem;
    }
  }

  .blog-content-start {
    color: var(--foreground);
    margin-bottom: 1rem;
    text-align: left;
  }

  .year-heading {
    margin: 1.5rem 0 1rem;
    color: var(--comment);
    text-align: left;
    font-size: 0.9rem;
  }

  .year-list {
    list-style: none;
    padding: 0;
    margin: 0 0 1rem 0;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }
  .posts-wrapper {
    margin-top: 2.5rem;
  }

  .post-row {
    display: flex;
    justify-content: flex-start;
    align-items: baseline;
    gap: 0.35rem;
    padding: 0.25rem 0.5rem;
    margin: 0 -0.5rem;

    &:hover {
      .post-link {
        text-decoration: underline;
      }
    }
  }

  .post-link {
    text-decoration: none;
    text-align: left;
    flex: 1 1 auto;
  }

  .post-date {
    color: var(--comment);
    white-space: nowrap;
    margin-left: 20px;
  }
</style>
