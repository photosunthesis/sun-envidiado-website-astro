---
import BackButton from '../../components/BackButton.astro';
import Newsletter from '../../components/Newsletter.astro';
import BaseLayout from '../../layouts/BaseLayout.astro';

const postModules = import.meta.glob<{
  frontmatter?: { title?: string; pubDate?: string };
}>(
  // Include .md and .mdx files, and also allow index.md(x) inside directories
  './**/*.{md,mdx}',
  { eager: true },
);

type Frontmatter = { title?: string; pubDate?: string };
type CandidatePost = { title: string; pubDate?: Date; url: string };
type PublishedPost = { title: string; pubDate: Date; url: string; index: number };

// Helpers
const slugFromPath = (path: string) => {
  // Remove the .md or .mdx extension and leading ./
  const cleanPath = path.replace(/\.mdx?$/, '').replace(/^\.\//, '');
  // If it ends with /index (standard Astro pattern), remove that part to get clean URLs
  return cleanPath.replace(/\/index$/, '');
};

const parsePubDate = (value?: unknown): Date | undefined => {
  if (!value) return undefined;
  const d = new Date(String(value));
  return Number.isFinite(d.valueOf()) ? d : undefined;
};

const makeCandidate = (path: string, mod: { frontmatter?: Frontmatter }): CandidatePost => {
  const slug = slugFromPath(path);
  const fm = mod.frontmatter ?? {};
  return {
    title: String(fm.title ?? slug),
    pubDate: parsePubDate(fm.pubDate),
    url: `/blog/${slug}`,
  };
};

// Build, filter, sort and index posts in a clear pipeline
const candidatePosts: CandidatePost[] = Object.entries(postModules).map(([p, m]) =>
  makeCandidate(p, m),
);

const posts: PublishedPost[] = candidatePosts
  .filter((c): c is CandidatePost & { pubDate: Date } => Boolean(c.pubDate))
  .sort((a, b) => b.pubDate.valueOf() - a.pubDate.valueOf())
  .map((p, i) => ({ title: p.title, pubDate: p.pubDate as Date, url: p.url, index: i }));

// Group posts by year using reduce for clarity
const postsByYear: Record<number, PublishedPost[]> = posts.reduce(
  (acc, p) => {
    const year = p.pubDate.getFullYear();
    (acc[year] ||= []).push(p);
    return acc;
  },
  {} as Record<number, PublishedPost[]>,
);

// Keep older variable names compatible with templates below
const postList = posts;
const grouped = postsByYear;

// SEO-optimized metadata
const seoMeta = {
  title: 'Blog â€” Sun Envidiado',
  description:
    'Random thoughts from Sun about coding, gaming, life updates, and whatever else crosses my mind. No formal structure, just honest musings about tech and everything in between.',
  tags: [
    'sun envidiado blog',
    'developer blog',
    'coding thoughts',
    'gaming blog',
    'personal blog',
    'tech musings',
  ],
};

// SEO / Structured Data
const siteBase = Astro.site || 'https://sun-envidiado.com';

// Optimized JSON-LD for a blog with individual posts
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Blog',
  '@id': `${siteBase}/blog#blog`,
  name: seoMeta.title,
  description: seoMeta.description,
  url: `${siteBase}/blog`,
  author: {
    '@type': 'Person',
    '@id': `${siteBase}/#person`,
    name: 'Sun Envidiado',
  },
  blogPost: postList.map((p) => ({
    '@type': 'BlogPosting',
    headline: p.title,
    url: new URL(p.url, siteBase).toString(),
    datePublished: p.pubDate.toISOString(),
    author: {
      '@type': 'Person',
      name: 'Sun Envidiado',
    },
  })),
};
---

<BaseLayout
  title={seoMeta.title}
  description={seoMeta.description}
  tags={seoMeta.tags}
  type="website"
  jsonLd={jsonLd}
>
  <div class="blog-content">
    <header class="blog-header">
      <h1 id="blog-title" class="sr-only">Blog</h1>
      <BackButton />
    </header>

    <Newsletter />

    <div class="posts-wrapper">
      {
        Object.keys(grouped)
          .sort((a, b) => Number(b) - Number(a))
          .map((year) => (
            <section class="year-group">
              <h2 class="year-heading" id={`year-${year}`}>
                {year}
              </h2>
              <ul class="year-list" aria-labelledby={`year-${year}`}>
                {grouped[Number(year)].map((post) => (
                  <li class="post-row" data-blog-index={post.index} data-blog-url={post.url}>
                    <a class="post-link" href={post.url} rel="bookmark">
                      {post.title}
                    </a>
                    <time class="post-date hide-on-mobile" datetime={post.pubDate.toISOString()}>
                      {post.pubDate.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric',
                      })}
                    </time>
                  </li>
                ))}
              </ul>
            </section>
          ))
      }
    </div>
  </div>
</BaseLayout>

<style lang="scss">
  .blog-content {
    max-width: 500px;
    text-align: left;
    width: 100%;

    @media (max-width: 480px) {
      padding: 1.5rem 1.5rem;
    }
  }

  .blog-content-start {
    color: var(--foreground);
    margin-bottom: 1rem;
    text-align: left;
  }

  .year-heading {
    margin: 1.5rem 0 1rem;
    color: var(--comment);
    text-align: left;
    font-size: 0.9rem;
  }

  .year-list {
    list-style: none;
    padding: 0;
    margin: 0 0 1rem 0;
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }
  .posts-wrapper {
    margin-top: 2.5rem;
  }

  .post-row {
    display: flex;
    justify-content: flex-start;
    align-items: baseline;
    gap: 0.35rem;
    padding: 0.25rem 0.5rem;
    margin: 0 -0.5rem;

    &:hover {
      .post-link {
        text-decoration: underline;
      }
    }
  }

  .post-link {
    text-decoration: none;
    text-align: left;
    flex: 1 1 auto;
  }

  .post-date {
    color: var(--comment);
    white-space: nowrap;
    margin-left: 20px;
  }
</style>
