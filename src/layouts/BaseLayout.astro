---
import '../styles/main.scss';
import { Picture } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import CommandBar from '../components/CommandBar.astro';
import Newsletter from '../components/Newsletter.astro';
import { buildSEOMetadata, SITE_CONFIG } from '../utils/seo';

const UI_CONFIG = {
  skipLinkText: 'Skip to content',
  skipLinkAria: 'Skip to main content',
  backUrlLabel: ':back<Enter>',
  homeUrlLabel: ':home<Enter>',
  blogFooter: {
    prefix: 'Tap/type',
    returnSuffix: 'to return to the previous page, or',
    homeSuffix: 'to go to the homepage.',
  },
} as const;

const isProd = import.meta.env && import.meta.env.PROD;
const props = Astro.props;
const frontmatter = props.frontmatter || props;
let coverImage: ImageMetadata | undefined;

if (frontmatter.cover) {
  try {
    const images = import.meta.glob<{ default: ImageMetadata }>(
      '/src/pages/blog/**/*.{jpeg,jpg,png,gif,webp}',
    );
    const imagePath = `/src/pages/blog/${frontmatter.cover.replace('./', '')}`;

    if (images[imagePath]) {
      const imageModule = await images[imagePath]();
      coverImage = imageModule.default;
    }
  } catch (e) {
    console.error('Failed to load cover image:', e);
  }
}

const seo = buildSEOMetadata({
  frontmatter,
  pathname: Astro.url.pathname,
  site: Astro.site,
  coverImage,
});

const jsonLd = frontmatter.jsonLd || null;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{seo.title}</title>
    <meta name="theme-color" content="#000000" />
    <meta name="msapplication-navbutton-color" content="#000000" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="#000000" />
    <meta name="description" content={seo.description} />
    <meta name="robots" content={seo.noIndex ? 'noindex, nofollow' : 'index, follow'} />
    <link rel="canonical" href={seo.canonical} />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <meta name="color-scheme" content="light dark" />
    <meta name="author" content={seo.author || SITE_CONFIG.authorName} />
    <link rel="sitemap" href="/sitemap-index.xml" />

    {seo.pubDate && <meta property="article:published_time" content={seo.pubDate} />}
    {seo.author && <meta property="article:author" content={seo.author} />}
    {
      seo.tags &&
        Array.isArray(seo.tags) &&
        seo.tags.length > 0 &&
        seo.tags.map((tag: string) => <meta property="article:tag" content={tag} />)
    }

    <meta property="og:site_name" content={SITE_CONFIG.siteName} />
    <meta property="og:type" content={seo.type} />
    <meta property="og:title" content={seo.title} />
    <meta property="og:description" content={seo.description} />
    <meta property="og:url" content={seo.canonical} />
    <meta property="og:image" content={seo.imageUrl} />

    <meta name="twitter:card" content={seo.imageUrl ? 'summary_large_image' : 'summary'} />
    <meta name="twitter:title" content={seo.title} />
    <meta name="twitter:description" content={seo.description} />
    <meta name="twitter:image" content={seo.imageUrl} />

    <slot name="seo" />

    <link
      rel="preload"
      href="/fonts/Web437_ToshibaSat_8x14.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />

    {jsonLd && <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />}

    {
      isProd && (
        <script
          defer
          src="https://umami.sun-envidiado.com/script.js"
          data-website-id="bbd2687f-9a6a-4aa4-8813-f5f431278ef6"
        />
      )
    }
  </head>
  <body class="vim-root crt-text-ca">
    <a class="skip-link" href="#main" aria-label={UI_CONFIG.skipLinkAria}
      >{UI_CONFIG.skipLinkText}</a
    >
    <div class="main-flex-container">
      <main id="main" class="vim-main-content" tabindex="-1">
        <div class="centered-vim">
          {
            seo.pubDate ? (
              <div class="blog-layout">
                {coverImage && (
                  <div class="cover-image-wrapper">
                    <Picture
                      src={coverImage}
                      formats={['avif', 'webp']}
                      alt={frontmatter.coverAlt || 'Cover image'}
                    />
                  </div>
                )}
                <h1 id="post-title" class="blog-title">
                  {frontmatter.title}
                </h1>
                <p class="post-pub-date">
                  {new Date(seo.pubDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                  })}
                </p>

                <article class="blog-article" aria-labelledby="post-title">
                  <slot />
                </article>

                <footer
                  class="blog-footer"
                  role="contentinfo"
                  aria-label="Post navigation and actions"
                >
                  <p class="blog-footer-text">
                    {UI_CONFIG.blogFooter.prefix}
                    <button
                      class="link-like"
                      type="button"
                      onclick="history.back();"
                      aria-label="Go back"
                    >
                      {UI_CONFIG.backUrlLabel}
                    </button>
                    {` ${UI_CONFIG.blogFooter.returnSuffix} `}
                    <a href="/" aria-label="Go to homepage">
                      {UI_CONFIG.homeUrlLabel}
                    </a>
                    {` ${UI_CONFIG.blogFooter.homeSuffix}`}
                  </p>
                </footer>

                <Newsletter />
              </div>
            ) : (
              <slot />
            )
          }
        </div>
      </main>
    </div>
    <CommandBar />
    <div id="crt-overlay-container" class="crt-enabled"></div>
    <div id="mouse-spotlight"></div>
    <script>
      const spotlight = document.getElementById('mouse-spotlight');
      let mouseX = 0;
      let mouseY = 0;
      let currentX = 0;
      let currentY = 0;
      let isActive = false;

      document.addEventListener('mousemove', (e) => {
        mouseX = e.clientX;
        mouseY = e.clientY;
        if (!isActive) {
          isActive = true;
          spotlight?.classList.add('active');
          requestAnimationFrame(updatePosition);
        }
      });

      document.addEventListener('mouseleave', () => {
        isActive = false;
        spotlight?.classList.remove('active');
      });

      function updatePosition() {
        if (!spotlight || !isActive) return;
        currentX += (mouseX - currentX) * 0.15;
        currentY += (mouseY - currentY) * 0.15;
        spotlight.style.left = `${currentX}px`;
        spotlight.style.top = `${currentY}px`;
        requestAnimationFrame(updatePosition);
      }
    </script>
  </body>
</html>
