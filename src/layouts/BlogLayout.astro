---
import type { ImageMetadata } from 'astro';
import { Picture } from 'astro:assets';
import Newsletter from '../components/Newsletter.astro';
import BaseLayout from './BaseLayout.astro';

const props = Astro.props;
const frontmatter = props.frontmatter || props;
let coverImage: ImageMetadata | undefined;

if (frontmatter.cover) {
  try {
    const images = import.meta.glob<{ default: ImageMetadata }>(
      '/src/pages/blog/**/*.{jpeg,jpg,png,gif,webp}',
    );
    const imagePath = `/src/pages/blog/${frontmatter.cover.replace('./', '')}`;

    if (images[imagePath]) {
      const imageModule = await images[imagePath]();
      coverImage = imageModule.default;
    }
  } catch (e) {
    console.error('Failed to load cover image:', e);
  }
}
---

<BaseLayout frontmatter={frontmatter} coverImage={coverImage}>
  <div class="blog-layout">
    <div class="back-to-home">
      <button id="back-button" aria-label="Go back">← Back</button>
    </div>

    {
      coverImage && (
        <div class="cover-image-wrapper">
          <Picture
            src={coverImage}
            formats={['avif', 'webp']}
            alt={frontmatter.coverAlt || 'Cover image'}
          />
        </div>
      )
    }
    <h1 id="post-title" class="blog-title">
      {frontmatter.title}
    </h1>
    <p class="post-pub-date">
      {
        frontmatter.pubDate &&
          new Date(frontmatter.pubDate).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          })
      }
    </p>

    <article class="blog-article" aria-labelledby="post-title">
      <slot />
    </article>

    <Newsletter hasBorderTop={true} />

    <div class="back-to-home">
      <button id="back-to-top-button" aria-label="Scroll to top">↑ Back to top</button>
    </div>
  </div>
</BaseLayout>

<script>
  const backButton = document.getElementById('back-button');
  if (backButton) {
    backButton.addEventListener('click', () => {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        window.location.href = '/';
      }
    });
  }

  const backToTopButton = document.getElementById('back-to-top-button');
  if (backToTopButton) {
    backToTopButton.addEventListener('click', () => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth',
      });
    });
  }
</script>

<style lang="scss">
  .blog-layout {
    margin: 1.5rem;
    max-width: 500px;
    text-align: left !important;

    * {
      text-align: left !important;
    }

    @media (max-width: 600px) {
      margin: 1.5rem 1rem;
    }
  }

  .post-pub-date {
    color: var(--comment);
    margin-top: -0.4rem;
  }

  .cover-image-wrapper {
    width: 100%;
    margin: 0 0 2rem;
  }

  .blog-article {
    margin-top: 2rem;
    margin-bottom: 2rem;
  }

  #back-to-top-button {
    margin-top: 2rem;
  }

  .blog-article :global(img),
  .blog-article :global(picture),
  .blog-article :global(picture > img) {
    display: block;
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    margin: 2rem auto;
  }

  .cover-image-wrapper :global(img),
  .cover-image-wrapper :global(picture),
  .cover-image-wrapper :global(picture > img) {
    display: block;
    width: 100%;
    max-width: 100%;
    height: auto;
    border-radius: 4px;
  }
</style>
