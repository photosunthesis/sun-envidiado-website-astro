---
import type { ImageMetadata } from 'astro';
import { Picture } from 'astro:assets';
import Newsletter from '../components/Newsletter.astro';
import BackButton from '../components/BackButton.astro';
import SEO from '../components/SEO.astro';
import BaseLayout from './BaseLayout.astro';
import { SITE_CONFIG, generateImageUrl } from '../utils/seo';

const props = Astro.props;
const frontmatter = props.frontmatter || props;
let coverImage: ImageMetadata | undefined;

if (frontmatter.cover) {
  try {
    const images = import.meta.glob<{ default: ImageMetadata }>(
      '/src/content/blog/**/*.{jpeg,jpg,png,gif,webp}',
    );
    const imagePath = `/src/content/blog/${frontmatter.cover.replace('./', '')}`;

    if (images[imagePath]) {
      const imageModule = await images[imagePath]();
      coverImage = imageModule.default;
    }
  } catch (e) {
    console.error('Failed to load cover image:', e);
  }
}

const rawTitle = frontmatter.title || SITE_CONFIG.siteName;
const title = frontmatter.pubDate ? `${rawTitle} — Sun Envidiado` : rawTitle;
const description = frontmatter.description || SITE_CONFIG.defaultDescription;
const imageUrl = coverImage
  ? generateImageUrl(coverImage.src, Astro.site)
  : frontmatter.image?.startsWith('http')
    ? frontmatter.image
    : generateImageUrl(frontmatter.image || SITE_CONFIG.defaultImage, Astro.site);

const tags = frontmatter.tags || [];
const pubDate = frontmatter.pubDate ? new Date(frontmatter.pubDate).toISOString() : undefined;

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: rawTitle,
  description: description,
  image: imageUrl,
  datePublished: pubDate,
  author: {
    '@type': 'Person',
    name: SITE_CONFIG.authorName,
    url: SITE_CONFIG.siteUrl,
  },
};
---

<BaseLayout>
  <SEO
    slot="head"
    title={title}
    description={description}
    image={imageUrl}
    type="article"
    pubDate={pubDate}
    tags={tags}
    jsonLd={jsonLd}
  />
  <div class="blog-layout">
    <BackButton />

    {
      coverImage && (
        <div class="cover-image-wrapper">
          <Picture
            src={coverImage}
            formats={['webp']}
            fallbackFormat="jpg"
            alt={frontmatter.coverAlt || 'Cover image'}
          />
        </div>
      )
    }
    <h1 id="post-title" class="blog-title">
      {frontmatter.title}
    </h1>
    <p class="post-pub-date">
      {
        frontmatter.pubDate &&
          new Date(frontmatter.pubDate).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          })
      }
    </p>

    <article class="blog-article" aria-labelledby="post-title">
      <slot />
    </article>

    <Newsletter hasBorderTop={true} />

    <div class="back-to-top-wrapper">
      <button id="back-to-top-button" aria-label="Scroll to top">↑ Back to top</button>
    </div>
  </div>
</BaseLayout>

<script>
  const backToTopButton = document.getElementById('back-to-top-button');
  if (backToTopButton) {
    backToTopButton.addEventListener('click', () => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth',
      });
    });
  }
</script>

<style lang="scss">
  .blog-layout {
    margin: 1.5rem;
    max-width: 500px;
    text-align: left !important;

    * {
      text-align: left !important;
    }

    @media (max-width: 600px) {
      margin: 1.5rem 1rem;
    }
  }

  .post-pub-date {
    color: var(--comment);
    margin-top: -0.4rem;
  }

  .cover-image-wrapper {
    width: 100%;
    margin: 0 0 2rem;
  }

  .blog-article {
    margin-top: 2rem;
    margin-bottom: 2rem;
  }

  #back-to-top-button {
    margin-top: 2rem;
  }

  .blog-article :global(img),
  .blog-article :global(picture),
  .blog-article :global(picture > img) {
    display: block;
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    margin: 2rem auto;
  }

  .cover-image-wrapper :global(img),
  .cover-image-wrapper :global(picture),
  .cover-image-wrapper :global(picture > img) {
    display: block;
    width: 100%;
    max-width: 100%;
    height: auto;
    border-radius: 4px;
  }

  .back-to-top-wrapper {
    padding-bottom: 1rem;

    button {
      color: var(--comment);
      padding: 0;
      text-decoration: none;

      &:hover {
        color: var(--cyan);
        text-decoration: underline;
      }
    }
  }

  .blog-article :global(figcaption) {
    font-size: 0.75rem;
    color: var(--comment);
    margin-top: -1rem;
    text-align: center !important;
  }
</style>
