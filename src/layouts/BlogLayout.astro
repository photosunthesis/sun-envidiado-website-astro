---
import BaseLayout from './BaseLayout.astro';
import Newsletter from '../components/Newsletter.astro';
import { Picture } from 'astro:assets';
import type { ImageMetadata } from 'astro';

const props = Astro.props;
const frontmatter = props.frontmatter || props;
let coverImage: ImageMetadata | undefined;

if (frontmatter.cover) {
  try {
    const images = import.meta.glob<{ default: ImageMetadata }>(
      '/src/pages/blog/**/*.{jpeg,jpg,png,gif,webp}',
    );
    const imagePath = `/src/pages/blog/${frontmatter.cover.replace('./', '')}`;

    if (images[imagePath]) {
      const imageModule = await images[imagePath]();
      coverImage = imageModule.default;
    }
  } catch (e) {
    console.error('Failed to load cover image:', e);
  }
}
---

<BaseLayout frontmatter={frontmatter} coverImage={coverImage}>
  <div class="blog-layout">
    {
      coverImage && (
        <div class="cover-image-wrapper">
          <Picture
            src={coverImage}
            formats={['avif', 'webp']}
            alt={frontmatter.coverAlt || 'Cover image'}
          />
        </div>
      )
    }
    <h1 id="post-title" class="blog-title">
      {frontmatter.title}
    </h1>
    <p class="post-pub-date">
      {
        frontmatter.pubDate &&
          new Date(frontmatter.pubDate).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          })
      }
    </p>

    <article class="blog-article" aria-labelledby="post-title">
      <slot />
    </article>

    <footer class="blog-footer" role="contentinfo" aria-label="Post navigation and actions">
      <p class="blog-footer-text">
        Tap/type
        <button class="link-like" type="button" onclick="history.back();" aria-label="Go back">
          :back&lt;Enter&gt;
        </button>
        {` to return to the previous page, or `}
        <a href="/" aria-label="Go to homepage"> :home&lt;Enter&gt; </a>
        {` to go to the homepage.`}
      </p>
    </footer>

    <Newsletter />
  </div>
</BaseLayout>

<style lang="scss">
  .blog-layout {
    margin: 1.5rem;
    max-width: 600px;
    text-align: left !important;

    * {
      text-align: left !important;
    }

    @media (max-width: 600px) {
      margin: 1.5rem 1rem;
    }
  }

  .blog-footer {
    margin-top: 2rem;
    color: var(--comment);
  }

  .blog-footer-text {
    margin-bottom: 1rem;
    line-height: 1.5;
  }

  .post-pub-date {
    color: var(--comment);
    margin-top: -0.4rem;
  }

  .cover-image-wrapper {
    width: 100%;
    margin: 0 0 2rem;
  }

  .blog-article :global(img),
  .blog-article :global(picture),
  .blog-article :global(picture > img) {
    display: block;
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    margin: 2rem auto;
  }

  .cover-image-wrapper :global(img),
  .cover-image-wrapper :global(picture),
  .cover-image-wrapper :global(picture > img) {
    display: block;
    width: 100%;
    max-width: 100%;
    height: auto;
    border-radius: 4px;
  }
</style>
